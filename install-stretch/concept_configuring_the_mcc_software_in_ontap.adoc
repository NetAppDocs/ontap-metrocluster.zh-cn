---
permalink: install-stretch/concept_configuring_the_mcc_software_in_ontap.html 
sidebar: sidebar 
keywords: metrocluster, stretch, installation, configure, software 
summary: 您必须在 ONTAP 中设置 MetroCluster 配置中的每个节点，包括节点级别配置以及将节点配置到两个站点。您还必须在两个站点之间实施 MetroCluster 关系。 
---
= 在 ONTAP 中配置 MetroCluster 软件
:icons: font
:imagesdir: ../media/


[role="lead"]
您必须在 ONTAP 中设置 MetroCluster 配置中的每个节点，包括节点级别配置以及将节点配置到两个站点。您还必须在两个站点之间实施 MetroCluster 关系。

image::../media/workflow_high_level_node_and_cluster_configuration_software.gif[工作流高级节点和集群配置软件]

.步骤
. 收集所需信息开始配置过程之前，需要收集控制器模块所需的 IP 地址。
. 站点 A 的 IP 网络信息工作表


[role="lead"]
在配置系统之前，您必须从网络管理员处获取第一个 MetroCluster 站点（站点 A ）的 IP 地址和其他网络信息。



==== 站点 A 集群创建信息

首次创建集群时，您需要以下信息：

|===
| 信息类型 | 您的价值 


 a| 
集群名称本指南中使用的示例： site_A
 a| 



 a| 
DNS 域
 a| 



 a| 
DNS 名称服务器
 a| 



 a| 
位置
 a| 



 a| 
管理员密码
 a| 

|===


==== 站点 A 节点信息

对于集群中的每个节点，您都需要一个管理 IP 地址，一个网络掩码和一个默认网关。

|===
| 节点 | 端口 | IP 地址 | 网络掩码 | 默认网关 


 a| 
本指南中使用的节点 1 示例： controller_A_1
 a| 
 a| 
 a| 
 a| 



 a| 
如果使用双节点 MetroCluster 配置（每个站点一个节点），则不需要节点 2 。

本指南中使用的示例： controller_A_2
 a| 
 a| 
 a| 
 a| 

|===


==== 用于集群对等的站点 A LIF 和端口

对于集群中的每个节点，您需要两个集群间 LIF 的 IP 地址，包括网络掩码和默认网关。集群间 LIF 用于为集群建立对等关系。

|===
| 节点 | 端口 | 集群间 LIF 的 IP 地址 | 网络掩码 | 默认网关 


 a| 
节点 1 IC LIF 1
 a| 
 a| 
 a| 
 a| 



 a| 
节点 1 IC LIF 2
 a| 
 a| 
 a| 
 a| 

|===


==== 站点 A 时间服务器信息

您必须同步时间，这需要一个或多个 NTP 时间服务器。

|===
| 节点 | 主机名 | IP 地址 | 网络掩码 | 默认网关 


 a| 
NTP 服务器 1.
 a| 
 a| 
 a| 
 a| 



 a| 
NTP 服务器 2.
 a| 
 a| 
 a| 
 a| 

|===


==== 站点 A AutoSupport 信息

您必须在每个节点上配置 AutoSupport ，这需要以下信息：

|===
2+| 信息类型 | 您的价值 


 a| 
发件人电子邮件地址
 a| 
 a| 



 a| 
邮件主机
 a| 
IP 地址或名称
 a| 



 a| 
传输协议
 a| 
HTTP ， HTTPS 或 SMTP
 a| 



 a| 
代理服务器
 a| 



 a| 
收件人电子邮件地址或分发列表
 a| 
完整长度的消息
 a| 



 a| 
简洁的消息
 a| 



 a| 
合作伙伴
 a| 

|===


==== 站点 A SP 信息

您必须启用对每个节点的服务处理器（ Service Processor ， SP ）的访问以进行故障排除和维护，这要求每个节点具有以下网络信息：

|===
| 节点 | IP 地址 | 网络掩码 | 默认网关 


 a| 
节点 1
 a| 
 a| 
 a| 

|===


=== 站点 B 的 IP 网络信息工作表

[role="lead"]
在配置系统之前，您必须从网络管理员处获取第二个 MetroCluster 站点（站点 B ）的 IP 地址和其他网络信息。



==== 站点 B 集群创建信息

首次创建集群时，您需要以下信息：

|===
| 信息类型 | 您的价值 


 a| 
集群名称本指南中使用的示例： site_B
 a| 



 a| 
DNS 域
 a| 



 a| 
DNS 名称服务器
 a| 



 a| 
位置
 a| 



 a| 
管理员密码
 a| 

|===


==== 站点 B 节点信息

对于集群中的每个节点，您都需要一个管理 IP 地址，一个网络掩码和一个默认网关。

|===
| 节点 | 端口 | IP 地址 | 网络掩码 | 默认网关 


 a| 
本指南中使用的节点 1 示例： controller_B_1
 a| 
 a| 
 a| 
 a| 



 a| 
双节点 MetroCluster 配置（每个站点一个节点）不需要节点 2 。

本指南中使用的示例： controller_B_2
 a| 
 a| 
 a| 
 a| 

|===


==== 用于集群对等的站点 B LIF 和端口

对于集群中的每个节点，您需要两个集群间 LIF 的 IP 地址，包括网络掩码和默认网关。集群间 LIF 用于为集群建立对等关系。

|===
| 节点 | 端口 | 集群间 LIF 的 IP 地址 | 网络掩码 | 默认网关 


 a| 
节点 1 IC LIF 1
 a| 
 a| 
 a| 
 a| 



 a| 
节点 1 IC LIF 2
 a| 
 a| 
 a| 
 a| 

|===


==== 站点 B 时间服务器信息

您必须同步时间，这需要一个或多个 NTP 时间服务器。

|===
| 节点 | 主机名 | IP 地址 | 网络掩码 | 默认网关 


 a| 
NTP 服务器 1.
 a| 
 a| 
 a| 
 a| 



 a| 
NTP 服务器 2.
 a| 
 a| 
 a| 
 a| 

|===


==== 站点 B AutoSupport 信息

您必须在每个节点上配置 AutoSupport ，这需要以下信息：

|===
2+| 信息类型 | 您的价值 


 a| 
发件人电子邮件地址
 a| 
 a| 



 a| 
邮件主机
 a| 
IP 地址或名称
 a| 



 a| 
传输协议
 a| 
HTTP ， HTTPS 或 SMTP
 a| 



 a| 
代理服务器
 a| 



 a| 
收件人电子邮件地址或分发列表
 a| 
完整长度的消息
 a| 



 a| 
简洁的消息
 a| 



 a| 
合作伙伴
 a| 

|===


==== 站点 B SP 信息

您必须启用对每个节点的服务处理器（ Service Processor ， SP ）的访问以进行故障排除和维护，这要求每个节点具有以下网络信息：

|===
| 节点 | IP 地址 | 网络掩码 | 默认网关 


 a| 
节点 1 （ controller_B_1 ）
 a| 
 a| 
 a| 

|===


== 标准集群和 MetroCluster 配置之间的相似之处和不同之处

[role="lead"]
在 MetroCluster 配置中，每个集群中的节点配置与标准集群中的节点配置类似。

MetroCluster 配置基于两个标准集群构建。在物理上，配置必须对称，每个节点都具有相同的硬件配置，并且所有 MetroCluster 组件都必须进行布线和配置。但是， MetroCluster 配置中节点的基本软件配置与标准集群中节点的基本软件配置相同。

|===
| 配置步骤 | 标准集群配置 | MetroCluster 配置 


 a| 
在每个节点上配置管理，集群和数据 LIF 。
 a| 
这两种类型的集群都相同



 a| 
配置根聚合。
 a| 
这两种类型的集群都相同



 a| 
在集群中的一个节点上设置集群。
 a| 
这两种类型的集群都相同



 a| 
将另一个节点加入集群。
 a| 
这两种类型的集群都相同



 a| 
创建镜像根聚合。
 a| 
可选
 a| 
必需



 a| 
为集群建立对等关系。
 a| 
可选
 a| 
必需



 a| 
启用 MetroCluster 配置。
 a| 
不适用
 a| 
必需

|===


== 还原系统默认值并在控制器模块上配置 HBA 类型

要确保 MetroCluster 安装成功，请重置和还原控制器模块上的默认值。只有使用 FC-SAS 网桥的延伸型配置才需要执行此任务。

.步骤
. 在 LOADER 提示符处，将环境变量返回到其默认设置：
+
`set-defaults`

. 将节点启动至维护模式，然后为系统中的任何 HBA 配置设置：
+
.. 启动至维护模式：
+
`boot_ontap maint`

.. 检查端口的当前设置：
+
`ucadmin show`

.. 根据需要更新端口设置。


+
|===
| 如果您具有此类型的 HBA 和所需模式 ... | 使用此命令 ... 


 a| 
CNA FC
 a| 
`ucadmin modify -m fc -t initiator _adapter_name_`



 a| 
CNA 以太网
 a| 
`ucadmin modify -mode cna _adapter_name_`



 a| 
FC 目标
 a| 
`fcadmin config -t target _adapter_name_`



 a| 
FC 启动程序
 a| 
`fcadmin config -t initiator _adapter_name_`

|===
. 退出维护模式：
+
`halt`

+
运行此命令后，请等待，直到节点停留在 LOADER 提示符处。

. 将节点重新启动至维护模式，以使配置更改生效：
+
`boot_ontap maint`

. 验证所做的更改：
+
|===
| 如果您使用的是此类型的 HBA... | 使用此命令 ... 


 a| 
CNA
 a| 
`ucadmin show`



 a| 
FC
 a| 
`fcadmin show`

|===
. 退出维护模式：
+
`halt`

+
运行此命令后，请等待，直到节点停留在 LOADER 提示符处。

. 将节点启动至启动菜单：
+
`boot_ontap 菜单`

+
运行此命令后，请等待，直到显示启动菜单为止。

. 在启动菜单提示符处键入 wipeconfig 以清除节点配置，然后按 Enter 键。
+
以下屏幕将显示启动菜单提示符：

+
--
....
Please choose one of the following:

     (1) Normal Boot.
     (2) Boot without /etc/rc.
     (3) Change password.
     (4) Clean configuration and initialize all disks.
     (5) Maintenance mode boot.
     (6) Update flash from backup config.
     (7) Install new software first.
     (8) Reboot node.
     (9) Configure Advanced Drive Partitioning.
     Selection (1-9)?  wipeconfig
 This option deletes critical system configuration, including cluster membership.
 Warning: do not run this option on a HA node that has been taken over.
 Are you sure you want to continue?: yes
 Rebooting to finish wipeconfig request.
....
--




== 在 FAS8020 系统上的 X1132A-R6 四端口卡上配置 FC-VI 端口

[role="lead"]
如果在 FAS8020 系统上使用 X1132A-R6 四端口卡，则可以进入维护模式来配置 1a 和 1b 端口以供 FC-VI 和启动程序使用。从工厂收到的 MetroCluster 系统不需要执行此操作，这些端口已根据您的配置进行了相应设置。

此任务必须在维护模式下执行。


NOTE: 只有 FAS8020 和 AFF 8020 系统才支持使用 ucadmin 命令将 FC 端口转换为 FC-VI 端口。任何其他平台均不支持将 FC 端口转换为 FCVI 端口。

.步骤
. 禁用端口：
+
` * 存储禁用适配器 1a*`

+
` * 存储禁用适配器 1b*`

+
[listing]
----
*> storage disable adapter 1a
Jun 03 02:17:57 [controller_B_1:fci.adapter.offlining:info]: Offlining Fibre Channel adapter 1a.
Host adapter 1a disable succeeded
Jun 03 02:17:57 [controller_B_1:fci.adapter.offline:info]: Fibre Channel adapter 1a is now offline.
*> storage disable adapter 1b
Jun 03 02:18:43 [controller_B_1:fci.adapter.offlining:info]: Offlining Fibre Channel adapter 1b.
Host adapter 1b disable succeeded
Jun 03 02:18:43 [controller_B_1:fci.adapter.offline:info]: Fibre Channel adapter 1b is now offline.
*>
----
. 验证端口是否已禁用：
+
` * ucadmin show*`

+
[listing]
----
*> ucadmin show
         Current  Current    Pending  Pending    Admin
Adapter  Mode     Type       Mode     Type       Status
-------  -------  ---------  -------  ---------  -------
  ...
  1a     fc       initiator  -        -          offline
  1b     fc       initiator  -        -          offline
  1c     fc       initiator  -        -          online
  1d     fc       initiator  -        -          online
----
. 将 a 和 b 端口设置为 FC-VI 模式：
+
` * ucadmin modify -adapter 1a -type fcvi*`

+
命令会在端口对 1a 和 1b 中的两个端口上设置模式（即使在命令中仅指定 1a ）。

+
[listing]
----

*> ucadmin modify -t fcvi 1a
Jun 03 02:19:13 [controller_B_1:ucm.type.changed:info]: FC-4 type has changed to fcvi on adapter 1a. Reboot the controller for the changes to take effect.
Jun 03 02:19:13 [controller_B_1:ucm.type.changed:info]: FC-4 type has changed to fcvi on adapter 1b. Reboot the controller for the changes to take effect.
----
. 确认此更改处于待定状态：
+
` * ucadmin show*`

+
[listing]
----
*> ucadmin show
         Current  Current    Pending  Pending    Admin
Adapter  Mode     Type       Mode     Type       Status
-------  -------  ---------  -------  ---------  -------
  ...
  1a     fc       initiator  -        fcvi       offline
  1b     fc       initiator  -        fcvi       offline
  1c     fc       initiator  -        -          online
  1d     fc       initiator  -        -          online
----
. 关闭控制器，然后重新启动到维护模式。
. 确认配置更改：
+
` * ucadmin show local*`

+
[listing]
----

Node           Adapter  Mode     Type       Mode     Type       Status
------------   -------  -------  ---------  -------  ---------  -----------
...
controller_B_1
               1a       fc       fcvi       -        -          online
controller_B_1
               1b       fc       fcvi       -        -          online
controller_B_1
               1c       fc       initiator  -        -          online
controller_B_1
               1d       fc       initiator  -        -          online
6 entries were displayed.
----




== 验证双节点配置中维护模式下的磁盘分配

[role="lead"]
在将系统完全启动到 ONTAP 之前，您可以选择将系统启动到维护模式并验证节点上的磁盘分配。应分配磁盘以创建完全对称的配置，其中两个站点都拥有自己的磁盘架并提供数据，其中每个节点和每个池都分配了相同数量的镜像磁盘。

系统必须处于维护模式。

新的 MetroCluster 系统在发货前已完成磁盘分配。

下表显示了 MetroCluster 配置的池分配示例。磁盘会按磁盘架分配给池。

|===
| 磁盘架（`示例名称` ） ... | 在站点 ... | 属于 ... | 并分配给该节点的 ... 


 a| 
磁盘架 1 （ shelf_A_1_1 ）
 a| 
站点 A
 a| 
节点 A 1.
 a| 
池 0



 a| 
磁盘架 2 （ shelf_A_1_3 ）



 a| 
磁盘架 3 （ shelf_B_1_1 ）
 a| 
节点 B 1
 a| 
池 1



 a| 
磁盘架 4 （ shelf_B_1_3 ）



 a| 
磁盘架 9 （ shelf_B_1_2 ）
 a| 
站点 B
 a| 
节点 B 1
 a| 
池 0



 a| 
磁盘架 10 （ shelf_B_1_4 ）



 a| 
磁盘架 11 （ shelf_A_1_2 ）
 a| 
节点 A 1.
 a| 
池 1



 a| 
磁盘架 12 （ shelf_A_1_4 ）

|===
如果您的配置包含 DS460C 磁盘架，则应按照以下准则为每个 12 磁盘抽盒手动分配磁盘：

|===
| 在抽盒中分配这些磁盘 ... | 到此节点和池 ... 


 a| 
1 - 6
 a| 
本地节点的池 0



 a| 
7 - 12
 a| 
DR 配对节点的池 1

|===
此磁盘分配模式可最大限度地减少抽盒脱机对聚合的影响。

.步骤
. 如果系统是从工厂收到的，请确认磁盘架分配：
+
` * disk show – v*`

. 如有必要，您可以使用 `disk assign` 命令将连接的磁盘架上的磁盘明确分配给相应的池。
+
与节点位于同一站点的磁盘架分配给池 0 ，而位于配对站点的磁盘架分配给池 1 。您应为每个池分配相同数量的磁盘架。

+
.. 如果尚未启动，请将每个系统启动至维护模式。
.. 在站点 A 的节点上，系统地将本地磁盘架分配给池 0 ，并将远程磁盘架分配给池 1 ： + ` * disk assign -shelf _disk_shelf_name_ -p _pool_*`
+
如果存储控制器 node_A_1 有四个磁盘架，则问题描述以下命令：

+
[listing]
----


*> disk assign -shelf shelf_A_1_1 -p 0
*> disk assign -shelf shelf_A_1_3 -p 0

*> disk assign -shelf shelf_A_1_2 -p 1
*> disk assign -shelf shelf_A_1_4 -p 1
----
.. 在远程站点（站点 B ）的节点上，系统地将其本地磁盘架分配给池 0 ，并将其远程磁盘架分配给池 1 ： + ` * disk assign -shelf _disk_shelf_name_ -p _pool_*`
+
如果存储控制器 node_B_1 有四个磁盘架，则问题描述以下命令：

+
[listing]
----


*> disk assign -shelf shelf_B_1_2   -p 0
*> disk assign -shelf shelf_B_1_4  -p 0

*> disk assign -shelf shelf_B_1_1 -p 1
 *> disk assign -shelf shelf_B_1_3 -p 1
----
.. 显示每个磁盘的磁盘架 ID 和托架： + ` * disk show – v*`






== 验证组件的 HA 状态

[role="lead"]
在出厂时未预配置的延伸型 MetroCluster 配置中，您必须验证控制器和机箱组件的 HA 状态是否设置为 `mcc-2n` ，以便它们可以正常启动。对于从工厂收到的系统，此值是预配置的，您无需对其进行验证。

系统必须处于维护模式。

.步骤
. 在维护模式下，查看控制器模块和机箱的 HA 状态：
+
` * ha-config show*`

+
控制器模块和机箱应显示值 `mcc-2n` 。

. 如果显示的控制器系统状态不是 `mcc-2n` ，请设置控制器的 HA 状态：
+
` * ha-config modify controller mcc-2n*`

. 如果显示的机箱系统状态不是 mcc-2n ，请设置机箱的 HA 状态：
+
` * ha-config modify chassis mcc-2n*`

+
暂停节点。

+
等待节点返回 LOADER 提示符。

. 对 MetroCluster 配置中的每个节点重复上述步骤。




== 在双节点 MetroCluster 配置中设置 ONTAP

[role="lead"]
在双节点 MetroCluster 配置中，您必须在每个集群上启动节点，退出集群设置向导，然后使用 `cluster setup` 命令将节点配置为单节点集群。

您不能事先配置服务处理器。

此任务适用于使用原生 NetApp 存储的双节点 MetroCluster 配置。

新的 MetroCluster 系统已预先配置；您无需执行这些步骤。但是，您应配置 AutoSupport 。

必须对 MetroCluster 配置中的两个集群执行此任务。

有关设置 ONTAP 的更多常规信息，请参见 link:https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-ssg/home.html["软件设置指南"]

.步骤
. 打开第一个节点的电源。
+

NOTE: 您必须在灾难恢复（ DR ）站点的节点上重复此步骤。

+
节点将启动，然后在控制台上启动集群设置向导，通知您 AutoSupport 将自动启用。

+
[listing]
----
::> Welcome to the cluster setup wizard.

You can enter the following commands at any time:
  "help" or "?" - if you want to have a question clarified,
  "back" - if you want to change previously answered questions, and
  "exit" or "quit" - if you want to quit the cluster setup wizard.
     Any changes you made before quitting will be saved.

You can return to cluster setup at any time by typing "cluster setup".
To accept a default or omit a question, do not enter a value.

This system will send event messages and periodic reports to NetApp Technical
Support. To disable this feature, enter
autosupport modify -support disable
within 24 hours.

Enabling AutoSupport can significantly speed problem determination and
resolution, should a problem occur on your system.
For further information on AutoSupport, see:
http://support.netapp.com/autosupport/

Type yes to confirm and continue {yes}: yes

Enter the node management interface port [e0M]:
Enter the node management interface IP address [10.101.01.01]:

Enter the node management interface netmask [101.010.101.0]:
Enter the node management interface default gateway [10.101.01.0]:



Do you want to create a new cluster or join an existing cluster? {create, join}:
----
. 创建新集群： ` * 创建 *`
. 选择是否将此节点用作单节点集群。
+
[listing]
----
Do you intend for this node to be used as a single node cluster? {yes, no} [yes]:
----
. 按 Enter 接受系统默认值 ` * 是 *` ，或者键入 ` * 否 *` 并按 Enter 输入您自己的值。
. 按照提示完成集群设置向导，按 Enter 接受默认值，或者键入您自己的值，然后按 Enter 。
+
默认值将根据您的平台和网络配置自动确定。

. 完成集群设置向导并退出后，验证集群是否处于活动状态且第一个节点是否运行正常：
+
` * 集群显示 *`

+
以下示例显示了一个集群，其中第一个节点（ cluster1-01 ）运行状况良好且符合参与条件：

+
[listing]
----
cluster1::> cluster show
Node                  Health  Eligibility
--------------------- ------- ------------
cluster1-01           true    true
----
+
如果需要更改为管理 SVM 或节点 SVM 输入的任何设置，您可以使用 `cluster setup` 命令访问集群设置向导。





== 将集群配置为 MetroCluster 配置

[role="lead"]
您必须对集群建立对等关系，镜像根聚合，创建镜像数据聚合，然后问题描述命令以实施 MetroCluster 操作。



=== 为集群建立对等关系

[role="lead"]
MetroCluster 配置中的集群必须处于对等关系中，以便它们可以彼此通信并执行对 MetroCluster 灾难恢复至关重要的数据镜像。

* 相关信息 *

http://docs.netapp.com/ontap-9/topic/com.netapp.doc.exp-clus-peer/home.html["集群和 SVM 对等快速配置"]

xref:concept_preparing_for_the_mcc_installation.adoc[使用专用端口时的注意事项]

xref:concept_preparing_for_the_mcc_installation.adoc[共享数据端口时的注意事项]



==== 配置集群间 LIF

[role="lead"]
您必须在用于 MetroCluster 配对集群之间通信的端口上创建集群间 LIF 。您可以使用专用端口或也具有数据流量的端口。



===== 在专用端口上配置集群间 LIF

[role="lead"]
您可以在专用端口上配置集群间 LIF 。这样做通常会增加复制流量的可用带宽。

.步骤
. 列出集群中的端口：
+
` * 网络端口显示 *`

+
有关完整的命令语法，请参见手册页。

+
以下示例显示了 `cluster01` 中的网络端口：

+
[listing]
----

cluster01::> network port show
                                                             Speed (Mbps)
Node   Port      IPspace      Broadcast Domain Link   MTU    Admin/Oper
------ --------- ------------ ---------------- ----- ------- ------------
cluster01-01
       e0a       Cluster      Cluster          up     1500   auto/1000
       e0b       Cluster      Cluster          up     1500   auto/1000
       e0c       Default      Default          up     1500   auto/1000
       e0d       Default      Default          up     1500   auto/1000
       e0e       Default      Default          up     1500   auto/1000
       e0f       Default      Default          up     1500   auto/1000
cluster01-02
       e0a       Cluster      Cluster          up     1500   auto/1000
       e0b       Cluster      Cluster          up     1500   auto/1000
       e0c       Default      Default          up     1500   auto/1000
       e0d       Default      Default          up     1500   auto/1000
       e0e       Default      Default          up     1500   auto/1000
       e0f       Default      Default          up     1500   auto/1000
----
. 确定哪些端口可专用于集群间通信：
+
` * 网络接口 show -fields home-port ， curr-port*`

+
有关完整的命令语法，请参见手册页。

+
以下示例显示未为端口 `e0e` 和 `e0f` 分配 LIF ：

+
[listing]
----

cluster01::> network interface show -fields home-port,curr-port
vserver lif                  home-port curr-port

Cluster cluster01-01_clus1   e0a       e0a
Cluster cluster01-01_clus2   e0b       e0b
Cluster cluster01-02_clus1   e0a       e0a
Cluster cluster01-02_clus2   e0b       e0b
cluster01
        cluster_mgmt         e0c       e0c
cluster01
        cluster01-01_mgmt1   e0c       e0c
cluster01
        cluster01-02_mgmt1   e0c       e0c
----
. 为专用端口创建故障转移组：
+
` * 网络接口故障转移组 create -vserver _system_svm_ -failover-group _failover_group_ -targets _physical_or_logical_ports_*`

+
以下示例将端口 e0e 和 e0f 分配给系统 SVMcluster01 上的故障转移组 intercluster01 ：

+
[listing]
----
cluster01::> network interface failover-groups create -vserver cluster01 -failover-group
intercluster01 -targets
cluster01-01:e0e,cluster01-01:e0f,cluster01-02:e0e,cluster01-02:e0f
----
. 验证是否已创建故障转移组：
+
` * 网络接口故障转移组 show *`

+
有关完整的命令语法，请参见手册页。

+
[listing]
----
cluster01::> network interface failover-groups show
                                  Failover
Vserver          Group            Targets
---------------- ---------------- --------------------------------------------
Cluster
                 Cluster
                                  cluster01-01:e0a, cluster01-01:e0b,
                                  cluster01-02:e0a, cluster01-02:e0b
cluster01
                 Default
                                  cluster01-01:e0c, cluster01-01:e0d,
                                  cluster01-02:e0c, cluster01-02:e0d,
                                  cluster01-01:e0e, cluster01-01:e0f
                                  cluster01-02:e0e, cluster01-02:e0f
                 intercluster01
                                  cluster01-01:e0e, cluster01-01:e0f
                                  cluster01-02:e0e, cluster01-02:e0f
----
. 在系统 SVM 上创建集群间 LIF 并将其分配给故障转移组。
+
[cols="1,3"]
|===


| ONTAP 版本 | 命令 


 a| 
9.6 及更高版本
 a| 
`network interface create -vserver system_sVM -lif LIF_name -service-policy default-intercluster -home-node node -home-port port -address port_ip -netmask -failover-group failover_group`



 a| 
9.5 及更早版本
 a| 
`network interface create -vserver system_sVM -lif LIF_name -role intercluster -home-node node -home-port port -address port_ip -netmask netmask -failover-group failover_group`

|===


有关完整的命令语法，请参见手册页。

+ 以下示例将在故障转移组 intercluster01 中创建集群间 LIF cluster01_icl01 和 cluster01_icl02 ：

+

[listing]
----
cluster01::> network interface create -vserver cluster01 -lif cluster01_icl01 -service-
policy default-intercluster -home-node cluster01-01 -home-port e0e -address 192.168.1.201
-netmask 255.255.255.0 -failover-group intercluster01

cluster01::> network interface create -vserver cluster01 -lif cluster01_icl02 -service-
policy default-intercluster -home-node cluster01-02 -home-port e0e -address 192.168.1.202
-netmask 255.255.255.0 -failover-group intercluster01
----
. 验证是否已创建集群间 LIF ：
+
|===
| * 在 ONTAP 9.6 及更高版本中： * 


 a| 
` * 网络接口 show -service-policy default-intercluster*`



 a| 
* 在 ONTAP 9.5 及更早版本中： *



 a| 
` * 网络接口 show -role intercluster*`

|===
+
有关完整的命令语法，请参见手册页。

+
[listing]
----
cluster01::> network interface show -service-policy default-intercluster
            Logical    Status     Network            Current       Current Is
Vserver     Interface  Admin/Oper Address/Mask       Node          Port    Home
----------- ---------- ---------- ------------------ ------------- ------- ----
cluster01
            cluster01_icl01
                       up/up      192.168.1.201/24   cluster01-01  e0e     true
            cluster01_icl02
                       up/up      192.168.1.202/24   cluster01-02  e0f     true
----
. 验证集群间 LIF 是否冗余：
+
|===
| * 在 ONTAP 9.6 及更高版本中： * 


 a| 
` * 网络接口 show -service-policy default-intercluster -failover*`



 a| 
* 在 ONTAP 9.5 及更早版本中： *



 a| 
` * 网络接口 show -role intercluster -failover*`

|===
+
有关完整的命令语法，请参见手册页。

+
以下示例显示 SVMe0e 端口上的集群间 LIF `cluster01_icl01` 和 `cluster01_icl02` 将故障转移到 `e0f` 端口。

+
[listing]
----
cluster01::> network interface show -service-policy default-intercluster –failover
         Logical         Home                  Failover        Failover
Vserver  Interface       Node:Port             Policy          Group
-------- --------------- --------------------- --------------- --------
cluster01
         cluster01_icl01 cluster01-01:e0e   local-only      intercluster01
                            Failover Targets:  cluster01-01:e0e,
                                               cluster01-01:e0f
         cluster01_icl02 cluster01-02:e0e   local-only      intercluster01
                            Failover Targets:  cluster01-02:e0e,
                                               cluster01-02:e0f
----


* 相关信息 *

xref:concept_preparing_for_the_mcc_installation.adoc[使用专用端口时的注意事项]



===== 在共享数据端口上配置集群间 LIF

[role="lead"]
您可以在与数据网络共享的端口上配置集群间 LIF 。这样可以减少集群间网络连接所需的端口数量。

.步骤
. 列出集群中的端口：
+
` * 网络端口显示 *`

+
有关完整的命令语法，请参见手册页。

+
以下示例显示了 `cluster01` 中的网络端口：

+
[listing]
----

cluster01::> network port show
                                                             Speed (Mbps)
Node   Port      IPspace      Broadcast Domain Link   MTU    Admin/Oper
------ --------- ------------ ---------------- ----- ------- ------------
cluster01-01
       e0a       Cluster      Cluster          up     1500   auto/1000
       e0b       Cluster      Cluster          up     1500   auto/1000
       e0c       Default      Default          up     1500   auto/1000
       e0d       Default      Default          up     1500   auto/1000
cluster01-02
       e0a       Cluster      Cluster          up     1500   auto/1000
       e0b       Cluster      Cluster          up     1500   auto/1000
       e0c       Default      Default          up     1500   auto/1000
       e0d       Default      Default          up     1500   auto/1000
----
. 在系统 SVM 上创建集群间 LIF ：
+
|===
| * 在 ONTAP 9.6 及更高版本中： * 


 a| 
` * 网络接口 create -vserver _system_svm_ -lif _LIF_name_ -service-policy default-intercluster -home-node node -home-port _port_ -address _port_ip_ -netmask _netmask_*`



 a| 
* 在 ONTAP 9.5 及更早版本中： *



 a| 
` * 网络接口 create -vserver _system_svm_ -lif _LIF_name_ -role intercluster -home-node _node_-home-port _port_ -address _port_ip_ -netmask _netmask_*`

|===
+
有关完整的命令语法，请参见手册页。

+
以下示例将创建集群间 LIF cluster01_icl01 和 cluster01_icl02 ：

+
[listing]
----

cluster01::> network interface create -vserver cluster01 -lif cluster01_icl01 -service-
policy default-intercluster -home-node cluster01-01 -home-port e0c -address 192.168.1.201
-netmask 255.255.255.0

cluster01::> network interface create -vserver cluster01 -lif cluster01_icl02 -service-
policy default-intercluster -home-node cluster01-02 -home-port e0c -address 192.168.1.202
-netmask 255.255.255.0
----
. 验证是否已创建集群间 LIF ：
+
|===


 a| 
* 在 ONTAP 9.6 及更高版本中： *



 a| 
` * 网络接口 show -service-policy default-intercluster*`



 a| 
* 在 ONTAP 9.5 及更早版本中： *



 a| 
` * 网络接口 show -role intercluster*`

|===
+
有关完整的命令语法，请参见手册页。

+
[listing]
----
cluster01::> network interface show -service-policy default-intercluster
            Logical    Status     Network            Current       Current Is
Vserver     Interface  Admin/Oper Address/Mask       Node          Port    Home
----------- ---------- ---------- ------------------ ------------- ------- ----
cluster01
            cluster01_icl01
                       up/up      192.168.1.201/24   cluster01-01  e0c     true
            cluster01_icl02
                       up/up      192.168.1.202/24   cluster01-02  e0c     true
----
. 验证集群间 LIF 是否冗余：
+
|===


 a| 
* 在 ONTAP 9.6 及更高版本中： *



 a| 
` * 网络接口 show – service-policy default-intercluster -failover*`



 a| 
* 在 ONTAP 9.5 及更早版本中： *



 a| 
` * 网络接口 show -role intercluster -failover*`

|===
+
有关完整的命令语法，请参见手册页。

+
以下示例显示， `e0c` 端口上的集群间 LIF `cluster01_icl01` `和 cluster01_icl02` 将故障转移到 `e0d` 端口。

+
[listing]
----
cluster01::> network interface show -service-policy default-intercluster –failover
         Logical         Home                  Failover        Failover
Vserver  Interface       Node:Port             Policy          Group
-------- --------------- --------------------- --------------- --------
cluster01
         cluster01_icl01 cluster01-01:e0c   local-only      192.168.1.201/24
                            Failover Targets: cluster01-01:e0c,
                                              cluster01-01:e0d
         cluster01_icl02 cluster01-02:e0c   local-only      192.168.1.201/24
                            Failover Targets: cluster01-02:e0c,
                                              cluster01-02:e0d
----


* 相关信息 *

xref:concept_preparing_for_the_mcc_installation.adoc[共享数据端口时的注意事项]



==== 创建集群对等关系

[role="lead"]
您必须在 MetroCluster 集群之间创建集群对等关系。



===== 创建集群对等关系

[role="lead"]
您可以使用 `cluster peer create` 命令在本地和远程集群之间创建对等关系。创建对等关系后，您可以在远程集群上运行 `cluster peer create` ，以便向本地集群进行身份验证。

* 您必须已在要建立对等关系的集群中的每个节点上创建集群间 LIF 。
* 集群必须运行 ONTAP 9.3 或更高版本。


.步骤
. 在目标集群上，创建与源集群的对等关系：
+
` * 集群对等创建 -generate-passphrase -offer-expiration _MM/DD/YYYY HH ： MM ： SS_|1...7 天 |1...168 小时 -peer-Addrs _peer_LIF_IP_ -IPspace _IPspace _*`

+
如果同时指定 ` generate-passphrase` 和 ` -peer-addrs` ，则只有在 ` -peer-addrs` 中指定了集群间 LIF 的集群才能使用生成的密码。

+
如果您不使用自定义 IP 空间，则可以忽略 ` -ipspace` 选项。有关完整的命令语法，请参见手册页。

+
以下示例将在未指定的远程集群上创建集群对等关系：

+
[listing]
----
cluster02::> cluster peer create -generate-passphrase -offer-expiration 2days

                     Passphrase: UCa+6lRVICXeL/gq1WrK7ShR
                Expiration Time: 6/7/2017 08:16:10 EST
  Initial Allowed Vserver Peers: -
            Intercluster LIF IP: 192.140.112.101
              Peer Cluster Name: Clus_7ShR (temporary generated)

Warning: make a note of the passphrase - it cannot be displayed again.
----
. 在源集群上，将源集群身份验证到目标集群：
+
` * 集群对等创建 -peer-addrs _peer_LIF_IPs_ -ipspace _IPspace_*`

+
有关完整的命令语法，请参见手册页。

+
以下示例将本地集群通过集群间 LIF IP 地址 192.140.112.101 和 192.140.112.102 向远程集群进行身份验证：

+
[listing]
----
cluster01::> cluster peer create -peer-addrs 192.140.112.101,192.140.112.102

Notice: Use a generated passphrase or choose a passphrase of 8 or more characters.
        To ensure the authenticity of the peering relationship, use a phrase or sequence of characters that would be hard to guess.

Enter the passphrase:
Confirm the passphrase:

Clusters cluster02 and cluster01 are peered.
----
+
出现提示时，输入对等关系的密码短语。

. 验证是否已创建集群对等关系：
+
` * cluster peer show -instance*`

+
[listing]
----
cluster01::> cluster peer show -instance

                               Peer Cluster Name: cluster02
                   Remote Intercluster Addresses: 192.140.112.101, 192.140.112.102
              Availability of the Remote Cluster: Available
                             Remote Cluster Name: cluster2
                             Active IP Addresses: 192.140.112.101, 192.140.112.102
                           Cluster Serial Number: 1-80-123456
                  Address Family of Relationship: ipv4
            Authentication Status Administrative: no-authentication
               Authentication Status Operational: absent
                                Last Update Time: 02/05 21:05:41
                    IPspace for the Relationship: Default
----
. 检查对等关系中节点的连接和状态：
+
` * 集群对等运行状况显示 *`

+
[listing]
----
cluster01::> cluster peer health show
Node       cluster-Name                Node-Name
             Ping-Status               RDB-Health Cluster-Health  Avail…
---------- --------------------------- ---------  --------------- --------
cluster01-01
           cluster02                   cluster02-01
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
                                       cluster02-02
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
cluster01-02
           cluster02                   cluster02-01
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
                                       cluster02-02
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
----




===== 创建集群对等关系（ ONTAP 9.2 及更早版本）

[role="lead"]
您可以使用 `cluster peer create` 命令在本地和远程集群之间启动对等关系请求。在本地集群请求建立对等关系后，您可以在远程集群上运行 `cluster peer create` 来接受此关系。

* 您必须已在要建立对等关系的集群中的每个节点上创建集群间 LIF 。
* 集群管理员必须已就每个集群用于向另一集群进行身份验证的密码短语达成一致。
+
.. 在数据保护目标集群上，与数据保护源集群创建对等关系：
+
` * 集群对等创建 -peer-addrs _peer_LIF_IPs_ -ipspace _IPspace_*`

+
如果您不使用自定义 IP 空间，则可以忽略 ` -ipspace` 选项。有关完整的命令语法，请参见手册页。

+
以下示例将与集群间 LIF IP 地址为 192.168.2.201 和 192.168.2.202 的远程集群创建集群对等关系：

+
[listing]
----
cluster02::> cluster peer create -peer-addrs 192.168.2.201,192.168.2.202
Enter the passphrase:
Please enter the passphrase again:
----
+
出现提示时，输入对等关系的密码短语。

.. 在数据保护源集群上，对目标集群的源集群进行身份验证：
+
` * 集群对等创建 -peer-addrs _peer_LIF_IPs_ -ipspace _IPspace_*`

+
有关完整的命令语法，请参见手册页。

+
以下示例将本地集群通过集群间 LIF IP 地址 192.140.112.203 和 192.140.112.204 的远程集群进行身份验证：

+
[listing]
----
cluster01::> cluster peer create -peer-addrs 192.168.2.203,192.168.2.204
Please confirm the passphrase:
Please confirm the passphrase again:
----
+
出现提示时，输入对等关系的密码短语。

.. 验证是否已创建集群对等关系：
+
` * cluster peer show – instance*`

+
有关完整的命令语法，请参见手册页。

+
[listing]
----
cluster01::> cluster peer show –instance
Peer Cluster Name: cluster01
Remote Intercluster Addresses: 192.168.2.201,192.168.2.202
Availability: Available
Remote Cluster Name: cluster02
Active IP Addresses: 192.168.2.201,192.168.2.202
Cluster Serial Number: 1-80-000013
----
.. 检查对等关系中节点的连接和状态：
+
` * 集群对等运行状况显示 *`

+
有关完整的命令语法，请参见手册页。

+
[listing]
----
cluster01::> cluster peer health show
Node       cluster-Name                Node-Name
             Ping-Status               RDB-Health Cluster-Health  Avail…
---------- --------------------------- ---------  --------------- --------
cluster01-01
           cluster02                   cluster02-01
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
                                       cluster02-02
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
cluster01-02
           cluster02                   cluster02-01
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
                                       cluster02-02
             Data: interface_reachable
             ICMP: interface_reachable true       true            true
----






=== 镜像根聚合

[role="lead"]
您必须镜像根聚合以提供数据保护。

默认情况下，根聚合创建为 RAID-DP 类型的聚合。您可以将根聚合从 RAID-DP 更改为 RAID4 类型的聚合。以下命令修改 RAID4 类型聚合的根聚合：

`storage aggregate modify – aggregate _aggr_name_ -RAIDType RAID4`


NOTE: 在非 ADP 系统上，可以在镜像聚合之前或之后将聚合的 RAID 类型从默认 RAID-DP 修改为 RAID4 。

.步骤
. 镜像根聚合：
+
` * 存储聚合镜像 _aggr_name_*`

+
以下命令镜像 controller_A_1 的根聚合：

+
[listing]
----
controller_A_1::> storage aggregate mirror aggr0_controller_A_1
----
+
此操作会镜像聚合，因此它包含一个本地丛和一个位于远程 MetroCluster 站点的远程丛。

. 对 MetroCluster 配置中的每个节点重复上述步骤。


* 相关信息 *

https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-vsmg/home.html["逻辑存储管理"]

https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-concepts/home.html["ONTAP 概念"]



=== 在每个节点上创建镜像数据聚合

[role="lead"]
您必须在 DR 组中的每个节点上创建镜像数据聚合。

* 您应了解新聚合将使用哪些驱动器或阵列 LUN 。
* 如果系统中有多种驱动器类型（异构存储），则应了解如何确保选择正确的驱动器类型。
* 驱动器和阵列 LUN 归特定节点所有；创建聚合时，该聚合中的所有驱动器都必须归同一节点所有，该节点将成为该聚合的主节点。
* 聚合名称应符合您在规划 MetroCluster 配置时确定的命名方案。
+
https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-psmg/home.html["磁盘和聚合管理"]



.步骤
. 显示可用备件列表：
+
` * storage disk show -spare -owner _node_name_*`

. 使用 `storage aggregate create -mirror true` 命令创建聚合。
+
如果您已通过集群管理界面登录到集群，则可以在集群中的任何节点上创建聚合。要确保在特定节点上创建聚合，请使用 ` -node` 参数或指定该节点所拥有的驱动器。

+
您可以指定以下选项：

+
** 聚合的主节点（即在正常操作下拥有聚合的节点）
** 要添加到聚合的特定驱动器或阵列 LUN 的列表
** 要包含的驱动器数量
+

NOTE: 在支持的最低配置中，可用驱动器数量有限，您必须使用 force-Small-aggregate 选项来创建三磁盘 RAID-DP 聚合。

** 要用于聚合的校验和模式
** 要使用的驱动器类型
** 要使用的驱动器大小
** 要使用的驱动器速度
** 聚合上 RAID 组的 RAID 类型
** 可包含在 RAID 组中的驱动器或阵列 LUN 的最大数量
** 有关这些选项的详细信息，请参见 `storage aggregate create` 手册页。
+
以下命令将创建包含 10 个磁盘的镜像聚合：

+
[listing]
----
cluster_A::> storage aggregate create aggr1_node_A_1 -diskcount 10 -node node_A_1 -mirror true
[Job 15] Job is queued: Create aggr1_node_A_1.
[Job 15] The job is starting.
[Job 15] Job succeeded: DONE
----


. 验证新聚合的 RAID 组和驱动器：
+
` * storage aggregate show-status -aggregate _aggregate-name_*`





=== 创建未镜像的数据聚合

[role="lead"]
您可以选择为不需要 MetroCluster 配置提供的冗余镜像的数据创建未镜像数据聚合。

* 您应了解新聚合将使用哪些驱动器或阵列 LUN 。
* 如果系统中有多种驱动器类型（异构存储），则应了解如何验证是否选择了正确的驱动器类型。


====
在 MetroCluster FC 配置中，只有当聚合中的远程磁盘可访问时，未镜像聚合才会在切换后联机。如果 ISL 发生故障，本地节点可能无法访问未镜像远程磁盘中的数据。聚合故障可能会导致本地节点重新启动。

====

NOTE: 未镜像聚合必须位于其所属节点的本地。

* 驱动器和阵列 LUN 归特定节点所有；创建聚合时，该聚合中的所有驱动器都必须归同一节点所有，该节点将成为该聚合的主节点。
* 聚合名称应符合您在规划 MetroCluster 配置时确定的命名方案。
* 。 link:https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-psmg/home.html["磁盘和聚合高级指南"] 包含有关镜像聚合的详细信息。


.步骤
. 显示可用备件列表：
+
` * storage disk show -spare -owner _node_name_*`

. 创建聚合：
+
` * 存储聚合 create*`

+
如果您已通过集群管理界面登录到集群，则可以在集群中的任何节点上创建聚合。要验证是否已在特定节点上创建聚合，应使用 ` -node` 参数或指定该节点所拥有的驱动器。

+
您可以指定以下选项：

+
** 聚合的主节点（即在正常操作下拥有聚合的节点）
** 要添加到聚合的特定驱动器或阵列 LUN 的列表
** 要包含的驱动器数量
** 要用于聚合的校验和模式
** 要使用的驱动器类型
** 要使用的驱动器大小
** 要使用的驱动器速度
** 聚合上 RAID 组的 RAID 类型
** 可包含在 RAID 组中的驱动器或阵列 LUN 的最大数量
** 有关这些选项的详细信息，请参见 `storage aggregate create` 手册页。
+
以下命令将创建一个包含 10 个磁盘的未镜像聚合：

+
[listing]
----
controller_A_1::> storage aggregate create aggr1_controller_A_1 -diskcount 10 -node controller_A_1
[Job 15] Job is queued: Create aggr1_controller_A_1.
[Job 15] The job is starting.
[Job 15] Job succeeded: DONE
----


. 验证新聚合的 RAID 组和驱动器：
+
` * storage aggregate show-status -aggregate _aggregate-name_*`





=== 实施 MetroCluster 配置

[role="lead"]
要在 MetroCluster 配置中启动数据保护，必须运行 `MetroCluster configure` 命令。

* 每个集群上应至少有两个非根镜像数据聚合。
+
其他数据聚合可以是镜像聚合，也可以是未镜像聚合。

+
您可以使用 `storage aggregate show` 命令进行验证。

+

NOTE: 如果要使用单个镜像数据聚合，请参见 xref:concept_configuring_the_mcc_software_in_ontap.adocSTEP_429E7F7532ED4B468B67B9B22968D686[第 1 步] 有关说明，请参见。

* 控制器和机箱的 ha-config 状态必须为 `mcc-2n` 。


您可以在任何节点上问题描述一次 `MetroCluster configure` 命令，以启用 MetroCluster 配置。您无需在每个站点或节点上对命令执行问题描述，也无需选择对哪个节点或站点执行问题描述命令。

.步骤
. 按以下格式配置 MetroCluster ：
+
|===
| 如果您的 MetroCluster 配置 ... | 然后执行此操作 ... 


 a| 
多个数据聚合
 a| 
从任何节点的提示符处，配置 MetroCluster ：

` * MetroCluster configure _node-name_*`



 a| 
一个镜像数据聚合
 a| 
.. 在任何节点的提示符处，更改为高级权限级别：
+
` * 设置 -privilege advanced*`

+
当系统提示您继续进入高级模式且您看到高级模式提示符（ * > ）时，您需要使用 `y` 进行响应。

.. 使用 ` -allow-with-one-aggregate true` 参数配置 MetroCluster ：
+
` * MetroCluster configure -allow-with-one-aggregate true _node-name_*`

.. 返回到管理权限级别： + ` * 设置 -privilege admin*`


|===
+

NOTE: 最佳实践是具有多个数据聚合。如果第一个 DR 组只有一个聚合，而您要添加一个具有一个聚合的 DR 组，则必须将元数据卷从单个数据聚合中移出。有关此操作步骤的详细信息，请参见 http://docs.netapp.com/ontap-9/topic/com.netapp.doc.hw-metrocluster-service/GUID-114DAE6E-F105-4908-ABB1-CE1D7B5C7048.html["在 MetroCluster 配置中移动元数据卷"]。

+
以下命令将在包含 controller_A_1 的 DR 组中的所有节点上启用 MetroCluster 配置：

+
[listing]
----
cluster_A::*> metrocluster configure -node-name controller_A_1

[Job 121] Job succeeded: Configure is successful.
----
. 验证站点 A 上的网络连接状态：
+
` * 网络端口显示 *`

+
以下示例显示了网络端口使用情况：

+
[listing]
----
cluster_A::> network port show
                                                          Speed (Mbps)
Node   Port      IPspace   Broadcast Domain Link   MTU    Admin/Oper
------ --------- --------- ---------------- ----- ------- ------------
controller_A_1
       e0a       Cluster   Cluster          up     9000  auto/1000
       e0b       Cluster   Cluster          up     9000  auto/1000
       e0c       Default   Default          up     1500  auto/1000
       e0d       Default   Default          up     1500  auto/1000
       e0e       Default   Default          up     1500  auto/1000
       e0f       Default   Default          up     1500  auto/1000
       e0g       Default   Default          up     1500  auto/1000

7 entries were displayed.
----
. 从 MetroCluster 配置中的两个站点验证 MetroCluster 配置。
+
.. 从站点 A 验证配置： + ` * MetroCluster show*`
+
[listing]
----
cluster_A::> metrocluster show

Cluster                   Entry Name          State
------------------------- ------------------- -----------
 Local: cluster_A         Configuration state configured
                          Mode                normal
                          AUSO Failure Domain auso-on-cluster-disaster
Remote: cluster_B         Configuration state configured
                          Mode                normal
                          AUSO Failure Domain auso-on-cluster-disaster
----
.. 从站点 B 验证配置： + ` * MetroCluster show*`
+
[listing]
----
cluster_B::> metrocluster show
Cluster                   Entry Name          State
------------------------- ------------------- -----------
 Local: cluster_B         Configuration state configured
                          Mode                normal
                          AUSO Failure Domain auso-on-cluster-disaster
Remote: cluster_A         Configuration state configured
                          Mode                normal
                          AUSO Failure Domain auso-on-cluster-disaster
----






=== 在 MetroCluster 配置中配置 SNMPv3

[role="lead"]
交换机和 ONTAP 系统上的身份验证和隐私协议必须相同。

ONTAP 当前支持 AES-128 和 AES-256 加密。

.步骤
. 在控制器提示符处为每个交换机创建一个 SNMP 用户：
+
` * 安全登录 cre*`

+
[listing]
----
Controller_A_1::> security login create -user-or-group-name snmpv3user -application snmp -authentication-method usm -role none -remote-switch-ipaddress 10.10.10.10
----
. 根据需要在您的站点上响应以下提示：
+
[listing]
----

Enter the authoritative entity's EngineID [remote EngineID]:

Which authentication protocol do you want to choose (none, md5, sha, sha2-256) [none]: sha

Enter the authentication protocol password (minimum 8 characters long):

Enter the authentication protocol password again:

Which privacy protocol do you want to choose (none, des, aes128) [none]: aes128

Enter privacy protocol password (minimum 8 characters long):

Enter privacy protocol password again:
----
+

NOTE: 可以将同一用户名添加到具有不同 IP 地址的不同交换机。

. 为其余交换机创建 SNMP 用户。
+
以下示例显示了如何为 IP 地址为 10.10.10.11 的交换机创建用户名。

+
[listing]
----
Controller_A_1::> security login create -user-or-group-name snmpv3user -application snmp -authentication-method usm -role none -remote-switch-ipaddress 10.
10.10.11
----
. 检查每个交换机是否有一个登录条目：
+
` * 安全登录显示 *`

+
[listing]
----
Controller_A_1::> security login show -user-or-group-name snmpv3user -fields remote-switch-ipaddress

vserver      user-or-group-name application authentication-method remote-switch-ipaddress

------------ ------------------ ----------- --------------------- -----------------------

node_A_1 SVM 1 snmpv3user     snmp        usm                   10.10.10.10

node_A_1 SVM 2 snmpv3user     snmp        usm                   10.10.10.11

node_A_1 SVM 3 snmpv3user    snmp        usm                   10.10.10.12

node_A_1 SVM 4 snmpv3user     snmp        usm                   10.10.10.13

4 entries were displayed.
----
. 从交换机提示符处为交换机配置 SNMPv3 ：
+
` * snmpconfig -set SNMPv3 *`

+
如果您需要 RO 访问，请在 "User （ ro ）： " 之后指定 "snmpv3use" ，如示例所示：

+
[listing]
----
Switch-A1:admin> snmpconfig --set snmpv3
SNMP Informs Enabled (true, t, false, f): [false] true
SNMPv3 user configuration(snmp user not configured in FOS user database will have physical AD and admin role as the default):
User (rw): [snmpadmin1]
Auth Protocol [MD5(1)/SHA(2)/noAuth(3)]: (1..3) [3]
Priv Protocol [DES(1)/noPriv(2)/AES128(3)/AES256(4)]): (2..2) [2]
Engine ID: [00:00:00:00:00:00:00:00:00]
User (ro): [snmpuser2] snmpv3user
Auth Protocol [MD5(1)/SHA(2)/noAuth(3)]: (1..3) [2]
Priv Protocol [DES(1)/noPriv(2)/AES128(3)/AES256(4)]): (2..2) [3]
----
+
此示例显示了如何配置只读用户。如果需要，您可以调整 RW 用户。您还应在未使用的帐户上设置密码，以保护这些帐户的安全，并使用 ONTAP 版本中提供的最佳加密方法。

. 根据需要在站点上的其余交换机用户上配置加密和密码。




=== 配置 FC-SAS 网桥以进行运行状况监控

[role="lead"]
在运行 ONTAP 9.8 之前版本的系统中，如果您的配置包含 FC-SAS 网桥，则必须执行一些特殊的配置步骤来监控 MetroCluster 配置中的 FC-SAS 网桥。

* FibreBridge 网桥不支持第三方 SNMP 监控工具。
* 从 ONTAP 9.8 开始，默认情况下， FC-SAS 网桥通过带内连接进行监控，不需要进行其他配置。



NOTE: 从 ONTAP 9.8 开始， ` * storage bridge*` 命令将替换为 ` * system bridge*` 。以下步骤显示了 ` * storage bridge*` 命令，但如果您运行的是 ONTAP 9.8 或更高版本，则首选使用 ` * system bridge*` 命令。

.步骤
. 在 ONTAP 集群提示符处，将此网桥添加到运行状况监控：
+
.. 使用适用于您的 ONTAP 版本的命令添加网桥：
+
|===
| ONTAP 版本 | 命令 


 a| 
9.5 及更高版本
 a| 
` * 存储网桥 add -address 0.0.0.0 -managed-by 带内 -name _bridge-name_*`



 a| 
9.4 及更早版本
 a| 
` * 存储网桥 add -address _bridge-ip-address_ -name _bridge-name_*`

|===
.. 验证是否已添加此网桥并已正确配置：
+
` * 存储网桥显示 *`

+
由于轮询间隔，可能需要长达 15 分钟才能反映所有数据。如果 `S状态` 列中的值为 `ok` ，并且显示了其他信息，例如全球通用名称（ WWN ），则 ONTAP 运行状况监控器可以联系并监控网桥。

+
以下示例显示已配置 FC-SAS 网桥：

+
[listing]
----
controller_A_1::> storage bridge show

Bridge              Symbolic Name Is Monitored  Monitor Status  Vendor Model                Bridge WWN
------------------  ------------- ------------  --------------  ------ -----------------    ----------
ATTO_10.10.20.10  atto01        true          ok              Atto   FibreBridge 7500N   	20000010867038c0
ATTO_10.10.20.11  atto02        true          ok              Atto   FibreBridge 7500N   	20000010867033c0
ATTO_10.10.20.12  atto03        true          ok              Atto   FibreBridge 7500N   	20000010867030c0
ATTO_10.10.20.13  atto04        true          ok              Atto   FibreBridge 7500N   	2000001086703b80

4 entries were displayed

 controller_A_1::>
----






=== 正在检查 MetroCluster 配置

[role="lead"]
您可以检查 MetroCluster 配置中的组件和关系是否工作正常。您应在初始配置后以及对 MetroCluster 配置进行任何更改后执行检查。您还应在协商（计划内）切换或切回操作之前执行检查。

如果在任一集群或同时在这两个集群上短时间内发出 `MetroCluster check run` 命令两次，则可能发生冲突，并且此命令可能无法收集所有数据。后续的 `MetroCluster check show` 命令不会显示预期输出。

. 检查配置：
+
` * MetroCluster check run*`

+
此命令作为后台作业运行，可能无法立即完成。

+
[listing]
----
cluster_A::> metrocluster check run
The operation has been started and is running in the background. Wait for
it to complete and run "metrocluster check show" to view the results. To
check the status of the running metrocluster check operation, use the command,
"metrocluster operation history show -job-id 2245"
----
+
[listing]
----
cluster_A::> metrocluster check show
Last Checked On: 9/13/2017 20:41:37

Component           Result
------------------- ---------
nodes               ok
lifs                ok
config-replication  ok
aggregates          ok
clusters            ok
5 entries were displayed.
----
. 显示最近的 `MetroCluster check run` 命令的更详细结果：
+
` * MetroCluster check aggregate show*`

+
` * MetroCluster check cluster show*`

+
` * MetroCluster check config-replication show*`

+
` * MetroCluster check lif show*`

+
` * MetroCluster check node show*`

+
`MetroCluster check show` 命令可显示最新的 `MetroCluster check run` 命令的结果。在使用 `MetroCluster check show` 命令之前，应始终运行 `MetroCluster check run` 命令，以使显示的信息为最新信息。

+
以下示例显示了运行正常的四节点 MetroCluster 配置的 `MetroCluster check aggregate show` 命令输出：

+
[listing]
----
cluster_A::> metrocluster check aggregate show

Last Checked On: 8/5/2014 00:42:58

Node                  Aggregate                  Check                      Result
---------------       --------------------       ---------------------      ---------
controller_A_1        controller_A_1_aggr0
                                                 mirroring-status           ok
                                                 disk-pool-allocation       ok
                                                 ownership-state            ok
                      controller_A_1_aggr1
                                                 mirroring-status           ok
                                                 disk-pool-allocation       ok
                                                 ownership-state            ok
                      controller_A_1_aggr2
                                                 mirroring-status           ok
                                                 disk-pool-allocation       ok
                                                 ownership-state            ok


controller_A_2        controller_A_2_aggr0
                                                 mirroring-status           ok
                                                 disk-pool-allocation       ok
                                                 ownership-state            ok
                      controller_A_2_aggr1
                                                 mirroring-status           ok
                                                 disk-pool-allocation       ok
                                                 ownership-state            ok
                      controller_A_2_aggr2
                                                 mirroring-status           ok
                                                 disk-pool-allocation       ok
                                                 ownership-state            ok

18 entries were displayed.
----
+
以下示例显示了运行正常的四节点 MetroCluster 配置的 `MetroCluster check cluster show` 命令输出。它表示集群已准备好在必要时执行协商切换。

+
[listing]
----
Last Checked On: 9/13/2017 20:47:04

Cluster               Check                           Result
--------------------- ------------------------------- ---------
mccint-fas9000-0102
                      negotiated-switchover-ready     not-applicable
                      switchback-ready                not-applicable
                      job-schedules                   ok
                      licenses                        ok
                      periodic-check-enabled          ok
mccint-fas9000-0304
                      negotiated-switchover-ready     not-applicable
                      switchback-ready                not-applicable
                      job-schedules                   ok
                      licenses                        ok
                      periodic-check-enabled          ok
10 entries were displayed.
----


* 相关信息 *

https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-psmg/home.html["磁盘和聚合管理"]

https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-nmg/home.html["网络和 LIF 管理"]



== 使用 Config Advisor 检查 MetroCluster 配置错误

[role="lead"]
您可以访问 NetApp 支持站点并下载 Config Advisor 工具以检查常见配置错误。

Config Advisor 是一款配置验证和运行状况检查工具。您可以将其部署在安全站点和非安全站点上，以便进行数据收集和系统分析。


NOTE: 对 Config Advisor 的支持是有限的，并且只能联机使用。

. 转到 Config Advisor 下载页面并下载此工具。
+
https://mysupport.netapp.com/site/tools/tool-eula/activeiq-configadvisor["NetApp 下载： Config Advisor"]

. 运行 Config Advisor ，查看该工具的输出并按照输出中的建议解决发现的任何问题。




== 验证切换，修复和切回

[role="lead"]
您应验证 MetroCluster 配置的切换，修复和切回操作。

. 使用中所述的协商切换，修复和切回过程 link:https://docs.netapp.com/us-en/ontap-metrocluster/manage/index.html["《 MetroCluster 管理和灾难恢复指南》"]。




== 保护配置备份文件

[role="lead"]
您可以通过指定一个远程 URL （ HTTP 或 FTP ）来为集群配置备份文件提供额外保护，除了本地集群中的默认位置之外，还可以将配置备份文件上传到该远程 URL 。

. 为配置备份文件设置远程目标的 URL ：
+
` * 系统配置备份设置 modify url-of-destination*`

+
。 link:https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-sag/home.html["《系统管理指南》"] 在 _Manag管理 配置备份 _ 一节下包含追加信息。


